# ============================================================
# E-Commerce Microservices + Observability Stack
# Demo Multi-Agent SRE System (STRATUS-inspired)
# ============================================================

services:
  # ========== BUSINESS SERVICES (Bounded Contexts) ==========

  # üì¶ Order Service - Qu·∫£n l√Ω ƒë∆°n h√†ng & Orchestration
  order-service:
    build: ./services/order-service
    container_name: order-service
    ports:
      - "5001:5001"
    environment:
      - PRODUCT_SERVICE_URL=http://product-service:5002
      - PAYMENT_SERVICE_URL=http://payment-service:5003
    depends_on:
      product-service:
        condition: service_started
      payment-service:
        condition: service_started
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5001/health')"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # üè∑Ô∏è Product Service - Qu·∫£n l√Ω s·∫£n ph·∫©m & t·ªìn kho
  product-service:
    build: ./services/product-service
    container_name: product-service
    ports:
      - "5002:5002"
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5002/health')"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # üí≥ Payment Service - X·ª≠ l√Ω thanh to√°n
  payment-service:
    build: ./services/payment-service
    container_name: payment-service
    ports:
      - "5003:5003"
    environment:
      - SIMULATE_DELAY=0
      - SIMULATE_FAILURE=false
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:5003/health')"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    restart: unless-stopped

  # ========== API GATEWAY ==========

  # üö™ Nginx API Gateway
  api-gateway:
    image: nginx:alpine
    container_name: api-gateway
    ports:
      - "80:80"
    volumes:
      - ./services/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      order-service:
        condition: service_healthy
      product-service:
        condition: service_healthy
      payment-service:
        condition: service_healthy
    networks:
      - ecommerce-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:80/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # ========== OBSERVABILITY STACK ==========

  # üìä Prometheus - Metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./services/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=1h"
    networks:
      - ecommerce-net
    restart: unless-stopped

  # üîç Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:latest
    container_name: jaeger
    ports:
      - "16686:16686"
      - "4317:4317"
      - "4318:4318"
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - ecommerce-net
    restart: unless-stopped

  # üìà cAdvisor - Container Metrics
  cadvisor:
    image: gcr.io/cadvisor/cadvisor:latest
    container_name: cadvisor
    ports:
      - "8080:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
    networks:
      - ecommerce-net
    restart: unless-stopped

  # üì° Nginx Exporter - Export Nginx metrics cho Prometheus
  nginx-exporter:
    image: nginx/nginx-prometheus-exporter:1.4.1
    container_name: nginx-exporter
    command:
      - --nginx.scrape-uri=http://api-gateway:80/nginx_status
    ports:
      - "9113:9113"
    depends_on:
      api-gateway:
        condition: service_healthy
    networks:
      - ecommerce-net
    restart: unless-stopped

networks:
  ecommerce-net:
    driver: bridge
    name: ecommerce-net


# # ============================================================
# # E-Commerce Microservices + Observability Stack
# # Demo Multi-Agent SRE System (STRATUS-inspired)
# # ============================================================

# services:
#   # ========== BUSINESS SERVICES (Bounded Contexts) ==========

#   # üì¶ Order Service - Qu·∫£n l√Ω ƒë∆°n h√†ng & Orchestration
#   order-service:
#     build: ./services/order-service
#     container_name: order-service
#     ports:
#       - "5001:5001"
#     environment:
#       - PRODUCT_SERVICE_URL=http://product-service:5002
#       - PAYMENT_SERVICE_URL=http://payment-service:5003
#     depends_on:
#       product-service:
#         condition: service_started
#       payment-service:
#         condition: service_started
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

#   # üè∑Ô∏è Product Service - Qu·∫£n l√Ω s·∫£n ph·∫©m & t·ªìn kho
#   product-service:
#     build: ./services/product-service
#     container_name: product-service
#     ports:
#       - "5002:5002"
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

#   # üí≥ Payment Service - X·ª≠ l√Ω thanh to√°n
#   payment-service:
#     build: ./services/payment-service
#     container_name: payment-service
#     ports:
#       - "5003:5003"
#     environment:
#       - SIMULATE_DELAY=0
#       - SIMULATE_FAILURE=false
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

#   # ========== API GATEWAY ==========

#   # üö™ Nginx API Gateway
#   api-gateway:
#     image: nginx:alpine
#     container_name: api-gateway
#     ports:
#       - "80:80"
#     volumes:
#       - ./services/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
#     depends_on:
#       - order-service
#       - product-service
#       - payment-service
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

#   # ========== OBSERVABILITY STACK ==========

#   # üìä Prometheus - Metrics collection
#   prometheus:
#     image: prom/prometheus:latest
#     container_name: prometheus
#     ports:
#       - "9090:9090"
#     volumes:
#       - ./services/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
#     command:
#       - "--config.file=/etc/prometheus/prometheus.yml"
#       - "--storage.tsdb.retention.time=1h"
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

#   # üîç Jaeger - Distributed Tracing
#   jaeger:
#     image: jaegertracing/all-in-one:latest
#     container_name: jaeger
#     ports:
#       - "16686:16686"   # Jaeger UI
#       - "4317:4317"     # OTLP gRPC receiver
#       - "4318:4318"     # OTLP HTTP receiver
#     environment:
#       - COLLECTOR_OTLP_ENABLED=true
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

#   # üìà cAdvisor - Container Metrics
#   cadvisor:
#     image: gcr.io/cadvisor/cadvisor:latest
#     container_name: cadvisor
#     ports:
#       - "8080:8080"
#     volumes:
#       - /var/run/docker.sock:/var/run/docker.sock:ro
#       - /sys:/sys:ro
#       - /var/lib/docker/:/var/lib/docker:ro
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

#   # üì° Nginx Exporter - Export Nginx metrics cho Prometheus
#   nginx-exporter:
#     image: nginx/nginx-prometheus-exporter:1.4.1
#     container_name: nginx-exporter
#     command:
#       - --nginx.scrape-uri=http://api-gateway:80/nginx_status
#     ports:
#       - "9113:9113"
#     depends_on:
#       - api-gateway
#     networks:
#       - ecommerce-net
#     restart: unless-stopped

# networks:
#   ecommerce-net:
#     driver: bridge
#     name: ecommerce-net
